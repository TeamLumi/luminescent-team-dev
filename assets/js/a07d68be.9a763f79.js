"use strict";(globalThis.webpackChunkluminescent_team=globalThis.webpackChunkluminescent_team||[]).push([[875404],{28453(e,n,t){t.d(n,{R:()=>s,x:()=>a});var o=t(296540);const i={},r=o.createContext(i);function s(e){const n=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(r.Provider,{value:n},e.children)}},339070(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"exefs/hooks","title":"Hooks","description":"Introduction","source":"@site/rom-hacking/exefs/hooks.md","sourceDirName":"exefs","slug":"/exefs/hooks","permalink":"/luminescent-team-dev/rom-hacking/exefs/hooks","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Headers","permalink":"/luminescent-team-dev/rom-hacking/exefs/headers"},"next":{"title":"Logging","permalink":"/luminescent-team-dev/rom-hacking/exefs/logging"}}');var i=t(474848),r=t(28453);const s={},a="Hooks",l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Replace Hook",id:"replace-hook",level:2},{value:"Trampoline Hook",id:"trampoline-hook",level:2},{value:"Inline Hook",id:"inline-hook",level:2}];function h(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"hooks",children:"Hooks"})}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"In ExLaunch, there are three types of hooks that are available to us. Each of them is useful for different reasons."}),"\n",(0,i.jsx)(n.p,{children:"Generally, hook definitions will look similar to this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"HOOK_DEFINE_<TYPE>(<Name>) {\r\n  static <ReturnType> Callback(<arguments>) {\r\n    // Code\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"replace-hook",children:"Replace Hook"}),"\n",(0,i.jsx)(n.p,{children:"This is the most common type of hook. It replaces the code of a function with the code defined in the hook."}),"\n",(0,i.jsxs)(n.p,{children:["Here is an example replace hook for the ",(0,i.jsx)(n.code,{children:"Dpr.Battle.Logic.MainModule$$GetMaxFollowPokeLevel"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"HOOK_DEFINE_REPLACE(Dpr_Battle_Logic_MainModule_GetMaxFollowPokeLevel) {\r\n  static uint8_t Callback(Dpr::Battle::Logic::MainModule::Object* __this) {\r\n    // Setting the obedience threshold to always be Lv. 100.\r\n    return 100;\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.p,{children:"The offset a replace hook is installed at is the offset of the replaced function."}),"\n",(0,i.jsx)(n.h2,{id:"trampoline-hook",children:"Trampoline Hook"}),"\n",(0,i.jsx)(n.p,{children:'This hook acts similarly to a replace hook, but allows the original function to be called from within it, therefore keeping it "intact" in a way.'}),"\n",(0,i.jsxs)(n.p,{children:["Here is an example trampoline hook for the ",(0,i.jsx)(n.code,{children:"FieldManager$$CheckAvailableFieldItem"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"HOOK_DEFINE_TRAMPOLINE(ShortcutCheckAvailability) {\r\n  static bool Callback(FieldManager::Object* __this, uint16_t itemno) {\r\n    if (CanUseRegisteredCustomItem(itemno)) {\r\n      return true;\r\n    }\r\n\r\n    return Orig(__this, itemno);\r\n  }\r\n};\n"})}),"\n",(0,i.jsxs)(n.p,{children:["As shown above, to call the original function, you simply call ",(0,i.jsx)(n.code,{children:"Orig()"})," with the arguments defined for ",(0,i.jsx)(n.code,{children:"Callback()"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The offset a trampoline hook is installed at is the offset of the replaced function."}),"\n",(0,i.jsx)(n.h2,{id:"inline-hook",children:"Inline Hook"}),"\n",(0,i.jsx)(n.p,{children:"This is the most complicated type of hook to deal with, but it can be very powerful when used to its full potential."}),"\n",(0,i.jsx)(n.p,{children:"Instead of installing it at the start of a function, this hook is installed at any offset and replaces one instruction. Because of this, we have direct access to registers instead of a function's arguments."}),"\n",(0,i.jsxs)(n.p,{children:["Here is an example inline hook at offset ",(0,i.jsx)(n.code,{children:"01daca9c"}),", for the ",(0,i.jsx)(n.code,{children:"FieldPlayerEntity$$CheckSwim"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"HOOK_DEFINE_INLINE(CheckSurfFlags) {\r\n  static void Callback(exl::hook::nx64::InlineCtx* ctx) {\r\n    bool result = true;\r\n    result &= PlayerWork::GetSystemFlag((int32_t)FlagWork_SysFlag::BADGE_ID_C06);\r\n    result &= PlayerWork::GetBool((int32_t)FlagWork_Flag::FE_HIDEN_03_GET);\r\n\r\n    ctx->X[0] = result ? 1 : 0;\r\n  }\r\n};\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The replaced instruction above is a simple call to ",(0,i.jsx)(n.code,{children:"FlagWork$$GetSysFlag"}),". We replace it with the original check, and also a second check to a work value."]}),"\n",(0,i.jsxs)(n.p,{children:["To access registers, we use the ",(0,i.jsx)(n.code,{children:"ctx"})," argument. It has a ",(0,i.jsx)(n.code,{children:"uint64_t"})," array called ",(0,i.jsx)(n.code,{children:"X"})," to access the 64-bit registers, and a ",(0,i.jsx)(n.code,{children:"uint32_t"})," array called ",(0,i.jsx)(n.code,{children:"W"})," for the 32-bit registers. These can be read and written to directly."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"W"})," registers represent the lower 32 bits of the corresponding ",(0,i.jsx)(n.code,{children:"X"})," registers. They are technically not a separate set of registers."]})}),"\n",(0,i.jsxs)(n.p,{children:["A function's arguments are typically stored in registers ",(0,i.jsx)(n.code,{children:"X0"})," to ",(0,i.jsx)(n.code,{children:"X7"})," at the start of it. When returning a value, a function writes that value to register ",(0,i.jsx)(n.code,{children:"X0"}),"."]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);